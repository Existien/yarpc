/* Generated by YARPC
 * Version:  0.1.0
 * Definition:
 *   File: /workspace/tests/definitions/02.1_with_args.yml
 *   Object: WithArgs
 *   Template: qt6/service_source.j2
 */
#include "WithArgsInterface.hpp"

using namespace gen::withArgs;

WithArgsInterface::WithArgsInterface(QObject* parent)
: QObject(parent) {
    m_adaptor = new WithArgsInterfaceAdaptor(this);
}

WithArgsInterfaceAdaptor::WithArgsInterfaceAdaptor(QObject* parent) : QDBusAbstractAdaptor(parent) {

}

void WithArgsInterface::connect(){
    if (m_connection != nullptr) {
        return;
    }
    m_connection = std::make_unique<QDBusConnection>(QDBusConnection::connectToBus(QDBusConnection::SessionBus, "com.yarpc.testservice"));
    bool success = m_connection->isConnected();
    if (success) {
        success = success && m_connection->registerService("com.yarpc.testservice");
        success = success && m_connection->registerObject(
            "/com/yarpc/testservice",
            "com.yarpc.testservice.withArgs",
            this
        );
        if (!success) {
            m_connection->disconnectFromBus("com.yarpc.testservice");
        }
    }
    if (!success) {
        m_connection = nullptr;
    }
    emit connectedChanged();
}
void WithArgsInterface::disconnect(){
    if (m_connection == nullptr) {
        return;
    }
    m_connection->disconnectFromBus("com.yarpc.testservice");
    m_connection = nullptr;
    emit connectedChanged();
}

bool WithArgsInterface::getConnected() const {
    return m_connection != nullptr;
}

void WithArgsInterface::EmitNotified(){
    emit m_adaptor->Notified();
}
void WithArgsInterface::EmitOrderReceived(){
    emit m_adaptor->OrderReceived();
}
void WithArgsInterfaceAdaptor::Notify(const QDBusMessage &message){
    auto iface = dynamic_cast<WithArgsInterface*>(parent());
    if (iface != nullptr) {
        message.setDelayedReply(true);
        iface->handleNotifyCalled(message);
    }
}

NotifyPendingReply::NotifyPendingReply(QDBusMessage call, QObject *parent) : QObject(parent) {
    m_call = call;
    m_args = NotifyArgs{};
}

NotifyArgs* NotifyPendingReply::args() {
    return &m_args;
}

void NotifyPendingReply::sendReply() {
    auto reply = m_call.createReply();
    auto iface = dynamic_cast<WithArgsInterface*>(parent());
    if (iface != nullptr) {
        iface->callFinished(reply);
    }
    deleteLater();
}

void NotifyPendingReply::sendError(const QString& name, const QString& message) {
    auto error_reply = m_call.createErrorReply(name, message);
    auto iface = dynamic_cast<WithArgsInterface*>(parent());
    if (iface != nullptr) {
        iface->callFinished(error_reply);
    }
    deleteLater();
}

void NotifyPendingReply::sendError(const DBusError &error) {
    auto error_reply = m_call.createErrorReply(error);
    auto iface = dynamic_cast<WithArgsInterface*>(parent());
    if (iface != nullptr) {
        iface->callFinished(error_reply);
    }
    deleteLater();
}

void WithArgsInterface::handleNotifyCalled(QDBusMessage call) {
    auto reply = new NotifyPendingReply(call, this);
    emit notifyCalled(reply);
}
void WithArgsInterfaceAdaptor::Order(const QDBusMessage &message){
    auto iface = dynamic_cast<WithArgsInterface*>(parent());
    if (iface != nullptr) {
        message.setDelayedReply(true);
        iface->handleOrderCalled(message);
    }
}

OrderPendingReply::OrderPendingReply(QDBusMessage call, QObject *parent) : QObject(parent) {
    m_call = call;
    m_args = OrderArgs{};
}

OrderArgs* OrderPendingReply::args() {
    return &m_args;
}

void OrderPendingReply::sendReply() {
    auto reply = m_call.createReply();
    auto iface = dynamic_cast<WithArgsInterface*>(parent());
    if (iface != nullptr) {
        iface->callFinished(reply);
    }
    deleteLater();
}

void OrderPendingReply::sendError(const QString& name, const QString& message) {
    auto error_reply = m_call.createErrorReply(name, message);
    auto iface = dynamic_cast<WithArgsInterface*>(parent());
    if (iface != nullptr) {
        iface->callFinished(error_reply);
    }
    deleteLater();
}

void OrderPendingReply::sendError(const DBusError &error) {
    auto error_reply = m_call.createErrorReply(error);
    auto iface = dynamic_cast<WithArgsInterface*>(parent());
    if (iface != nullptr) {
        iface->callFinished(error_reply);
    }
    deleteLater();
}

void WithArgsInterface::handleOrderCalled(QDBusMessage call) {
    auto reply = new OrderPendingReply(call, this);
    emit orderCalled(reply);
}

void WithArgsInterface::callFinished(const QDBusMessage &reply)
{
    m_connection->send(reply);
}