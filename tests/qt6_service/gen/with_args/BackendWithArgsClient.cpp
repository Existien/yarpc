/* Generated by YARPC
 * Version:  0.1.0
 * Definition:
 *   File: /workspace/tests/definitions/02.1_with_args.yml
 *   Object: WithArgs
 *   Template: qt6/client_source.j2
 */
#include "BackendWithArgsClient.hpp"
#include <QDBusConnection>
#include <QDBusInterface>
#include <QDBusReply>
#include <QDBusPendingCall>
#include <QDBusPendingReply>

using namespace gen::withArgs;

BackendWithArgsClient::BackendWithArgsClient(QObject* parent)
 : QObject(parent),
   m_watcher(QDBusServiceWatcher(
    "com.yarpc.backend",
    QDBusConnection::sessionBus(),
    QDBusServiceWatcher::WatchForRegistration | QDBusServiceWatcher::WatchForUnregistration,
    parent
   ))
{

    QDBusInterface iface(
        "com.yarpc.backend",
        "/com/yarpc/backend",
        "com.yarpc.backend.withArgs",
        QDBusConnection::sessionBus()
    );
    m_connected = iface.isValid();

    connect(
        &m_watcher, &QDBusServiceWatcher::serviceRegistered,
        this, &BackendWithArgsClient::connectedHandler
    );
    connect(
        &m_watcher, &QDBusServiceWatcher::serviceUnregistered,
        this, &BackendWithArgsClient::disconnectedHandler
    );

    QDBusConnection::sessionBus().connect(
        "com.yarpc.backend",
        "/com/yarpc/backend",
        "com.yarpc.backend.withArgs",
        "Notified",
        this,
        SLOT(NotifiedDBusHandler(QDBusMessage))
    );
    QDBusConnection::sessionBus().connect(
        "com.yarpc.backend",
        "/com/yarpc/backend",
        "com.yarpc.backend.withArgs",
        "OrderReceived",
        this,
        SLOT(OrderReceivedDBusHandler(QDBusMessage))
    );

}

bool BackendWithArgsClient::getConnected() const {
    return m_connected;
}

void BackendWithArgsClient::connectedHandler(const QString& service) {
    m_connected = true;
    emit connectedChanged();
}

void BackendWithArgsClient::disconnectedHandler(const QString& service) {
    m_connected = false;
    emit connectedChanged();
}


void BackendWithArgsClient::NotifiedDBusHandler(QDBusMessage content) {
    emit notifiedReceived();
}

void BackendWithArgsClient::OrderReceivedDBusHandler(QDBusMessage content) {
    emit orderReceivedReceived();
}
NotifyPendingCall* BackendWithArgsClient::Notify() {
    QDBusInterface iface(
        "com.yarpc.backend",
        "/com/yarpc/backend",
        "com.yarpc.backend.withArgs",
        QDBusConnection::sessionBus()
    );
    QDBusPendingCall pendingCall {iface.asyncCall(
        "Notify"
    )};
    return new NotifyPendingCall(pendingCall, this);
}

NotifyPendingCall::NotifyPendingCall(QDBusPendingCall pendingCall, QObject *parent)
: QObject(parent), m_watcher(pendingCall, this) {
    QObject::connect(
        &m_watcher, &QDBusPendingCallWatcher::finished,
        this, &NotifyPendingCall::callFinished
    );
}

void NotifyPendingCall::callFinished(QDBusPendingCallWatcher *watcher)
{
    QDBusPendingReply<void> reply {*watcher};
    if (!reply.isValid()) {
        emit error(reply.error());
    } else {
        emit finished();
    }
    deleteLater();
}

OrderPendingCall* BackendWithArgsClient::Order() {
    QDBusInterface iface(
        "com.yarpc.backend",
        "/com/yarpc/backend",
        "com.yarpc.backend.withArgs",
        QDBusConnection::sessionBus()
    );
    QDBusPendingCall pendingCall {iface.asyncCall(
        "Order"
    )};
    return new OrderPendingCall(pendingCall, this);
}

OrderPendingCall::OrderPendingCall(QDBusPendingCall pendingCall, QObject *parent)
: QObject(parent), m_watcher(pendingCall, this) {
    QObject::connect(
        &m_watcher, &QDBusPendingCallWatcher::finished,
        this, &OrderPendingCall::callFinished
    );
}

void OrderPendingCall::callFinished(QDBusPendingCallWatcher *watcher)
{
    QDBusPendingReply<void> reply {*watcher};
    if (!reply.isValid()) {
        emit error(reply.error());
    } else {
        emit finished();
    }
    deleteLater();
}




