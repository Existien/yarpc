/* Generated by YARPC
 * Version:  0.1.0
 * Definition:
 *   File: /workspace/tests/definitions/05.3_dictionaries_with_arrays.yml
 *   Object: DictsWithArrays
 *   Template: qt6/service_source.j2
 */
#include <QDBusArgument>
#include "DictsWithArraysInterface.hpp"
#include "DictsWithArraysInterfaceAdaptor.hpp"
#include "Connection.hpp"
#include "types.hpp"

using namespace gen::dicts;
using namespace DictsWithArraysInterfaceUtils;

DictsWithArraysInterface::DictsWithArraysInterface(QObject* parent)
: QObject(parent) {
    registerMetaTypes();
    QObject::connect(
        &Connection::instance(),
        &Connection::connectedChanged,
        this,
        &DictsWithArraysInterface::connectedChanged
    );
    QObject::connect(
        &Connection::instance(),
        &Connection::registrationChanged,
        this,
        &DictsWithArraysInterface::connectedChanged
    );
}

void DictsWithArraysInterface::connect() {
    Connection::instance().registerDictsWithArrays(this);
}

void DictsWithArraysInterface::disconnect() {
    Connection::instance().unregisterDictsWithArrays();
}

void DictsWithArraysInterface::finishCall(const QDBusMessage &reply)
{
    Connection::instance().send(reply);
}

bool DictsWithArraysInterface::getConnected() const {
    return (
        Connection::instance().getConnected()
        && Connection::instance().isDictsWithArraysRegistered()
    );
}

DictsArrayMethodPendingReply::DictsArrayMethodPendingReply(QDBusMessage call, QObject *parent) : QObject(parent) {
    m_call = call;
    QMap<QString, QList<QMap<QString, uint>>> arg_0;
    {
        auto marshalled = m_call.arguments()[0].value<QDBusArgument>();
        marshalled >> arg_0;
    }
    m_args = DictsArrayMethodArgs{
        .numbers = static_cast<QMap<QString, QList<QMap<QString, uint>>>>(arg_0),
    };
}

DictsArrayMethodArgs DictsArrayMethodPendingReply::args() {
    return m_args;
}

void DictsArrayMethodPendingReply::sendReply(
    QVariant reply
) {
    QMap<QString, QList<QMap<QString, uint>>> unmarshalled;
    unmarshalled = reply.value<QMap<QString, QList<QMap<QString, uint>>>>();

    sendReply(unmarshalled);
}

void DictsArrayMethodPendingReply::sendReply(
    const QMap<QString, QList<QMap<QString, uint>>> &reply
) {
    auto replyToSend = static_cast<QMap<QString, QList<QMap<QString, uint>>>>(reply);
    auto dbusReply = m_call.createReply(QVariant::fromValue(replyToSend));
    auto iface = dynamic_cast<DictsWithArraysInterface*>(parent());
    if (iface != nullptr) {
        iface->finishCall(dbusReply);
    }
    deleteLater();
}

void DictsArrayMethodPendingReply::sendError(const QString& name, const QString& message) {
    auto error_reply = m_call.createErrorReply(name, message);
    auto iface = dynamic_cast<DictsWithArraysInterface*>(parent());
    if (iface != nullptr) {
        iface->finishCall(error_reply);
    }
    deleteLater();
}

void DictsArrayMethodPendingReply::sendError(const DBusError &error) {
    auto error_reply = m_call.createErrorReply(error);
    auto iface = dynamic_cast<DictsWithArraysInterface*>(parent());
    if (iface != nullptr) {
        iface->finishCall(error_reply);
    }
    deleteLater();
}

void DictsWithArraysInterface::handleDictsArrayMethodCalled(QDBusMessage call) {
    auto reply = new DictsArrayMethodPendingReply(call, this);
    emit dictsArrayMethodCalled(reply);
}

void DictsWithArraysInterface::EmitDictsArraySignal(
    QMap<QString, QList<QMap<QString, uint>>> numbers
) {
    if (Connection::instance().DictsWithArrays() != nullptr ) {
        emit Connection::instance().DictsWithArrays()->DictsArraySignal(
            numbers
        );
    }
}

void DictsWithArraysInterface::EmitDictsArraySignal(
    QVariant numbers
) {
    QMap<QString, QList<QMap<QString, uint>>> arg_0;
    arg_0 = numbers.value<QMap<QString, QList<QMap<QString, uint>>>>();

    EmitDictsArraySignal(
        arg_0
    );
}

QMap<QString, QList<QMap<QString, uint>>> DictsWithArraysInterface::getDictArrayProperty() const {
    return m_DictArrayProperty;
}

void DictsWithArraysInterface::setDictArrayProperty(const QMap<QString, QList<QMap<QString, uint>>> &value ) {
    m_DictArrayProperty = value;
    emit dictArrayPropertyChanged();
    if (Connection::instance().DictsWithArrays() != nullptr ) {
        QVariantMap changedProps;
        changedProps.insert("DictArrayProperty", QVariant::fromValue(static_cast<QMap<QString, QList<QMap<QString, uint>>>>(value)));
        emitPropertiesChangedSignal(changedProps);
    }
}

QVariant DictsWithArraysInterface::getVariantDictArrayProperty() const {
    auto unmarshalled = getDictArrayProperty();
    QVariant marshalled;
    marshalled = QVariant::fromValue(unmarshalled);

    return marshalled;
}

void DictsWithArraysInterface::setVariantDictArrayProperty(QVariant value ) {
    QMap<QString, QList<QMap<QString, uint>>> unmarshalled;
    unmarshalled = value.value<QMap<QString, QList<QMap<QString, uint>>>>();

    setDictArrayProperty(unmarshalled);
}


void DictsWithArraysInterface::emitPropertiesChangedSignal(const QVariantMap &changedProps) {
    auto signal = QDBusMessage::createSignal(
        "/com/yarpc/testservice/dicts",
        "org.freedesktop.DBus.Properties",
        "PropertiesChanged"
    );
    signal << "com.yarpc.testservice.dictsWithArrays";
    signal << changedProps;
    signal << QStringList{};
    Connection::instance().send(signal);
}