/* Generated by YARPC
 * Version:  0.1.0
 * Definition:
 *   File: /workspace/tests/definitions/05.1_dictionaries.yml
 *   Object: Dicts
 *   Template: qt6/service_source.j2
 */
#include "DictsInterface.hpp"
#include "DictsInterfaceAdaptor.hpp"
#include "Connection.hpp"
#include <QMetaType>
#include <QDBusMetaType>

using namespace gen::dicts;

DictsInterface::DictsInterface(QObject* parent)
: QObject(parent) {
    qRegisterMetaType<StructDict>("StructDict");
    qDBusRegisterMetaType<StructDict>();
    qRegisterMetaType<SimonsDict>("SimonsDict");
    qDBusRegisterMetaType<SimonsDict>();
    QObject::connect(
        &Connection::instance(),
        &Connection::connectedChanged,
        this,
        &DictsInterface::connectedChanged
    );
    QObject::connect(
        &Connection::instance(),
        &Connection::registrationChanged,
        this,
        &DictsInterface::connectedChanged
    );
}

void DictsInterface::connect() {
    Connection::instance().registerDicts(this);
}

void DictsInterface::disconnect() {
    Connection::instance().unregisterDicts();
}

void DictsInterface::finishCall(const QDBusMessage &reply)
{
    Connection::instance().send(reply);
}

bool DictsInterface::getConnected() const {
    return (
        Connection::instance().getConnected()
        && Connection::instance().isDictsRegistered()
    );
}

DictMethodPendingReply::DictMethodPendingReply(QDBusMessage call, QObject *parent) : QObject(parent) {
    m_call = call;
    m_args = DictMethodArgs{
        .keysNValues = m_call.arguments()[0].value<QMap<$1, $2>>(),
    };
}

DictMethodArgs DictMethodPendingReply::args() {
    return m_args;
}

void DictMethodPendingReply::sendReply(
    const QMap<$1, $2> &reply
) {
    auto dbusReply = m_call.createReply(QVariant::fromValue(reply));
    auto iface = dynamic_cast<DictsInterface*>(parent());
    if (iface != nullptr) {
        iface->finishCall(dbusReply);
    }
    deleteLater();
}

void DictMethodPendingReply::sendError(const QString& name, const QString& message) {
    auto error_reply = m_call.createErrorReply(name, message);
    auto iface = dynamic_cast<DictsInterface*>(parent());
    if (iface != nullptr) {
        iface->finishCall(error_reply);
    }
    deleteLater();
}

void DictMethodPendingReply::sendError(const DBusError &error) {
    auto error_reply = m_call.createErrorReply(error);
    auto iface = dynamic_cast<DictsInterface*>(parent());
    if (iface != nullptr) {
        iface->finishCall(error_reply);
    }
    deleteLater();
}

void DictsInterface::handleDictMethodCalled(QDBusMessage call) {
    auto reply = new DictMethodPendingReply(call, this);
    emit dictMethodCalled(reply);
}

void DictsInterface::EmitDictSignal(
    QMap<$1, $2> keysNValues
) {
    if (Connection::instance().Dicts() != nullptr ) {
        emit Connection::instance().Dicts()->DictSignal(
            keysNValues
        );
    }
}

QMap<$1, $2> DictsInterface::getDictProperty() const {
    return m_DictProperty;
}

void DictsInterface::setDictProperty(const QMap<$1, $2> &value ) {
    m_DictProperty = value;
    emit dictPropertyChanged();
    if (Connection::instance().Dicts() != nullptr ) {
        QVariantMap changedProps;
        changedProps.insert("DictProperty", QVariant::fromValue(value));
        emitPropertiesChangedSignal(changedProps);
    }
}


void DictsInterface::emitPropertiesChangedSignal(const QVariantMap &changedProps) {
    auto signal = QDBusMessage::createSignal(
        "/com/yarpc/testservice/dicts",
        "org.freedesktop.DBus.Properties",
        "PropertiesChanged"
    );
    signal << "com.yarpc.testservice.dicts";
    signal << changedProps;
    signal << QStringList{};
    Connection::instance().send(signal);
}