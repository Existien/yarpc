/* Generated by YARPC
 * Version:  {{version}}
 * Definition:
 *   File: {{ object.definitionPath }}
 *   Object: {{ object.name }}
 *   Template: qt6/client_source.j2
 */
{% import "dbus/common.j2" as dbus %}
{% import "qt6/common.j2" as qt6 %}
#include "{{ target.className }}.hpp"
#include <QDBusConnection>
#include <QDBusInterface>
#include <QDBusReply>
#include <QDBusPendingCall>
#include <QDBusPendingReply>

using namespace {{ qt6.namespace(output) }};

{{ target.className }}::{{ target.className }}(QObject* parent)
 : QObject(parent),
   m_watcher(QDBusServiceWatcher(
    "{{ target.busName }}",
    QDBusConnection::sessionBus(),
    QDBusServiceWatcher::WatchForRegistration | QDBusServiceWatcher::WatchForUnregistration,
    parent
   ))
{

    QDBusInterface iface(
        "{{ target.busName }}",
        "{{ target.objectPath }}",
        "{{ target.interfaceName }}",
        QDBusConnection::sessionBus()
    );
    m_connected = iface.isValid();

    connect(
        &m_watcher, &QDBusServiceWatcher::serviceRegistered,
        this, &{{ target.className }}::connectedHandler
    );
    connect(
        &m_watcher, &QDBusServiceWatcher::serviceUnregistered,
        this, &{{ target.className }}::disconnectedHandler
    );

    QDBusConnection::sessionBus().connect(
        "{{ target.busName }}",
        "{{ target.objectPath }}",
        "org.freedesktop.DBus.Properties",
        "PropertiesChanged",
        this,
        SLOT(propertiesChangedHandler(QString, QVariantMap, QStringList))
    );
{% for member in object.members %}
{% if member.kind == 'signal' %}
    QDBusConnection::sessionBus().connect(
        "{{ target.busName }}",
        "{{ target.objectPath }}",
        "{{ target.interfaceName }}",
        "{{ member.name }}",
        this,
        SLOT({{ member.name}}DBusHandler(QDBusMessage))
    );
{% endif %}
{% endfor %}

}

bool {{ target.className }}::getConnected() const {
    return m_connected;
}

QVariantMap {{ target.className }}::getAllProperties() const {
    QDBusInterface iface(
        "{{ target.busName }}",
        "{{ target.objectPath }}",
        "org.freedesktop.DBus.Properties",
        QDBusConnection::sessionBus()
    );
    QDBusReply<QVariantMap> reply = iface.call(
        "GetAll",
        "{{ target.interfaceName }}"
    );
    if (!reply.isValid()) {
        return QVariantMap();
    } else {
        return reply.value();
    }
}

void {{ target.className }}::connectedHandler(const QString& service) {
    m_connected = true;
    emit connectedChanged();
}

void {{ target.className }}::disconnectedHandler(const QString& service) {
    m_connected = false;
    emit connectedChanged();
}

void {{ target.className }}::propertiesChangedHandler(QString iface, QVariantMap changes, QStringList) {
    if (iface != "{{ target.interfaceName }}") {
        return;
    }
    {% for member in object.members %}
    {% if member.kind == 'property' %}
    if (changes.contains("{{ member.name }}")) {
        emit {{ member.name|camel_case }}Changed();
    }
    {% endif %}
    {% endfor %}
}

{% for member in object.members %}
{% if member.kind == 'method'%}
{{ member.name }}PendingCall* {{ target.className }}::{{ member.name }}(
    {{ qt6.funcparams(member, output.objects)|indent(4) }}
) {
    {% for arg in member.args %}
    QDBusArgument dbus{{ arg.name }};
    dbus{{ arg.name }} << {{ arg.name }};
    {% endfor %}
    QDBusInterface iface(
        "{{ target.busName }}",
        "{{ target.objectPath }}",
        "{{ target.interfaceName }}",
        QDBusConnection::sessionBus()
    );
    QDBusPendingCall pendingCall {iface.asyncCall(
        "{{ member.name }}"
        {%- if member.args|count > 0 -%}
        ,
        {% endif %}
        {% for i in range(0, member.args|count) %}
        {% set arg = member.args[i] %}
        QVariant::fromValue(dbus{{ arg.name }})
        {%- if i < member.args|count - 1 -%}
        ,
        {% endif %}
        {% endfor %}

    )};
    return new {{ member.name }}PendingCall(pendingCall, this);
}

{{ member.name }}PendingCall::{{ member.name }}PendingCall(QDBusPendingCall pendingCall, QObject *parent)
: QObject(parent), m_watcher(pendingCall, this) {
    QObject::connect(
        &m_watcher, &QDBusPendingCallWatcher::finished,
        this, &{{ member.name }}PendingCall::callFinished
    );
}

void {{ member.name }}PendingCall::callFinished(QDBusPendingCallWatcher *watcher)
{
    {% if member.returns is defined %}
    {% set reply_type = qt6.type(member.returns.type, output.objects) %}
    {% else %}
    {% set reply_type = "void" %}
    {% endif %}
    QDBusPendingReply<{{ reply_type }}> reply {*watcher};
    if (!reply.isValid()) {
        emit error(reply.error());
    } else {
        {% if member.returns is defined %}
        emit finished(reply);
        {% else %}
        emit finished();
        {% endif %}
    }
    deleteLater();
}
{% endif %}

{% if member.kind == 'signal' %}
void {{ target.className }}::{{ member.name }}DBusHandler(QDBusMessage content) {
    emit {{ member.name|camel_case }}Received(
        {% for i in range(0, member.args|count) %}
        {% set arg = member.args[i] %}
        {% set argument = "content.arguments()[" + i|string + "].value<" + qt6.type(arg.type, output.objects) + ">()" %}
        {{ argument }}
        {%- if i < member.args|count - 1 -%}
        ,
        {% endif %}
        {% endfor %}

    );
}
{% endif %}
{% if member.kind == 'property' %}

{{ qt6.type(member.type, output.objects) }} {{ target.className }}::get{{ member.name }}() const {
    QDBusInterface iface(
        "{{ target.busName }}",
        "{{ target.objectPath }}",
        "{{ target.interfaceName }}",
        QDBusConnection::sessionBus()
    );
    return iface.property("{{ member.name }}").value<{{ qt6.type(member.type, output.objects) }}>();
}
{% if member.readonly != true %}

void {{ target.className }}::set{{ member.name }}(const {{ qt6.type(member.type, output.objects) }} &newValue) {
    QDBusInterface iface(
        "{{ target.busName }}",
        "{{ target.objectPath }}",
        "{{ target.interfaceName }}",
        QDBusConnection::sessionBus()
    );
    iface.setProperty("{{ member.name }}", newValue);
}
{% endif %}
{% endif %}
{% endfor %}
